# Stash unstaged changes (keep index)
git stash --keep-index --quiet
STASHED=$?

# Function to restore stash and exit with status
restore_and_exit() {
  if [ $STASHED -eq 0 ]; then
    echo "🔁 Restoring unstaged changes..."
    git stash pop --quiet || true
  fi
  exit $1
}

echo "🏗️  Building project..."
pnpm build || restore_and_exit $?

# Automatically stage any build output that changed
echo "➕ Staging build artifacts..."
git add dist/ || restore_and_exit $?

echo "🔍 Running biome..."
pnpm biome ci --threads=4 || restore_and_exit $?

echo "🧪 Running tests..."
pnpm test || restore_and_exit $?

# All checks passed
restore_and_exit 0
